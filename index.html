<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCWorld Forum</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: url('grass.jpg') repeat;
            background-size: 64px 64px;
            image-rendering: pixelated;
            font-family: Verdana, Arial, sans-serif;
            font-size: 11px;
            color: #000;
            min-height: 100vh;
        }

        a {
            color: #006699;
            text-decoration: none;
            cursor: pointer;
        }

        a:hover {
            text-decoration: underline;
        }

        /* HEADER */
        .forum-header {
            background: linear-gradient(180deg, #1a7a1a 0%, #0d4d0d 100%);
            border-bottom: 4px solid #5aad14;
            padding: 10px 0 8px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .forum-header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: repeating-linear-gradient(90deg, #5aad14 0px, #5aad14 8px, #3a8c00 8px, #3a8c00 16px);
        }

        .forum-header h1 {
            font-family: "Impact", "Arial Black", Verdana, sans-serif;
            font-size: 36px;
            color: #fff;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
            letter-spacing: 4px;
            text-transform: uppercase;
        }

        .forum-header h1 span {
            color: #7dde2f;
        }

        .forum-header .subtitle {
            font-size: 10px;
            color: #aaffaa;
            margin-top: 3px;
            letter-spacing: 2px;
            font-family: "Courier New", monospace;
        }

        /* NAVBAR */
        .navbar {
            background: linear-gradient(180deg, #2d2d2d, #1a1a1a);
            border-bottom: 2px solid #5aad14;
            padding: 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .navbar a,
        .navbar span {
            color: #ddd;
            font-size: 11px;
            margin-right: 2px;
            cursor: pointer;
        }

        .navbar a:hover {
            color: #7dde2f;
            text-decoration: none;
        }

        .navbar .user-info {
            color: #7dde2f;
            font-weight: bold;
        }

        .nav-links a {
            padding: 6px 12px;
            color: #ccc !important;
            display: inline-block;
            margin: 0;
            font-size: 11px;
            font-weight: bold;
            border-right: 1px solid #333;
            transition: background 0.1s;
        }

        .nav-links a:hover {
            background: #3a3a3a;
            color: #7dde2f !important;
            text-decoration: none;
        }

        .wrapper {
            max-width: 900px;
            margin: 10px auto;
            padding: 0 8px;
        }

        /* SECTION HEADER */
        .section-header {
            background: linear-gradient(180deg, #3a8c14, #1e5a00);
            color: #fff;
            padding: 6px 10px;
            font-weight: bold;
            font-size: 12px;
            border: 1px solid #2a6600;
            text-shadow: 1px 1px 0 #000;
            margin-top: 8px;
            letter-spacing: 1px;
        }

        /* FORMS */
        .form-box {
            background: #f0f0e8;
            border: 2px solid #888;
            border-top: 3px solid #5aad14;
            padding: 15px;
            margin: 10px 0;
        }

        .form-box h2 {
            font-size: 13px;
            color: #1a5a00;
            margin-bottom: 10px;
            border-bottom: 1px solid #bbb;
            padding-bottom: 4px;
            font-family: "Impact", Verdana, sans-serif;
            letter-spacing: 1px;
        }

        .form-row {
            margin: 6px 0;
        }

        .form-row label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
            font-size: 11px;
            vertical-align: top;
        }

        .form-row input[type="text"],
        .form-row input[type="password"],
        .form-row input[type="file"],
        .form-row textarea,
        .form-row select {
            border: 2px inset #ccc;
            padding: 3px 5px;
            font-family: Verdana, Arial, sans-serif;
            font-size: 11px;
            background: #fff;
        }

        .form-row input[type="text"],
        .form-row input[type="password"] {
            width: 200px;
        }

        .form-row textarea {
            width: 100%;
            height: 80px;
            resize: vertical;
        }

        .form-row select {
            padding: 2px;
        }

        /* BUTTONS */
        .btn {
            font-family: Verdana, Arial, sans-serif;
            font-size: 11px;
            padding: 4px 14px;
            cursor: pointer;
            border: 2px outset #ccc;
            background: linear-gradient(180deg, #f0f0f0, #d0d0d0);
            color: #333;
            font-weight: bold;
        }

        .btn:hover {
            background: linear-gradient(180deg, #e0e8e0, #c0d0c0);
        }

        .btn:active {
            border-style: inset;
        }

        .btn-primary {
            background: linear-gradient(180deg, #5aad14, #3a8c00);
            color: #fff;
            border-color: #2a6600;
            text-shadow: 1px 1px 0 #000;
        }

        .btn-primary:hover {
            background: linear-gradient(180deg, #6dcc1a, #4aaa00);
        }

        .btn-danger {
            background: linear-gradient(180deg, #cc5555, #993333);
            color: #fff;
            border-color: #772222;
        }

        .btn-danger:hover {
            background: linear-gradient(180deg, #dd6666, #aa4444);
        }

        .btn-warn {
            background: linear-gradient(180deg, #cc9933, #996622);
            color: #fff;
            border-color: #774411;
        }

        .btn-warn:hover {
            background: linear-gradient(180deg, #ddaa44, #aa7733);
        }

        .btn-success {
            background: linear-gradient(180deg, #55aa55, #338833);
            color: #fff;
            border-color: #226622;
        }

        /* ROLE BADGES */
        .role-badge {
            font-size: 9px;
            font-weight: bold;
            padding: 1px 5px;
            border: 1px solid;
            display: inline-block;
            margin-left: 4px;
        }

        .role-player {
            color: #555;
            background: #e0e0e0;
            border-color: #999;
        }

        .role-vip {
            color: #b8860b;
            background: #fff8dc;
            border-color: #daa520;
        }

        .role-moder {
            color: #006600;
            background: #d0ffd0;
            border-color: #090;
        }

        .role-admin {
            color: #cc0000;
            background: #ffd0d0;
            border-color: #c00;
        }

        /* POSTS */
        .post-item {
            background: #fff;
            border: 1px solid #999;
            border-top: 2px solid #5aad14;
            margin: 6px 0;
        }

        .post-header {
            background: linear-gradient(180deg, #e8f5e0, #d0e8c0);
            padding: 5px 8px;
            border-bottom: 1px solid #aac099;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-header .post-title {
            font-weight: bold;
            font-size: 12px;
            color: #1a5a00;
        }

        .post-header .post-meta {
            font-size: 10px;
            color: #666;
        }

        .post-body {
            padding: 8px 10px;
            font-size: 11px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .post-author {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .post-author-name {
            font-weight: bold;
            color: #1a5a00;
        }

        .post-media {
            padding: 5px 10px;
        }

        .post-media img {
            max-width: 400px;
            max-height: 300px;
            border: 1px solid #999;
            cursor: pointer;
        }

        .post-media video {
            max-width: 400px;
            max-height: 300px;
            border: 1px solid #999;
        }

        .avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 2px;
            border: 1px solid #888;
            object-fit: cover;
            vertical-align: middle;
        }

        .avatar-big {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            border: 2px solid #888;
            object-fit: cover;
        }

        /* REPLIES */
        .replies {
            border-top: 1px dashed #bbb;
        }

        .reply-item {
            padding: 5px 10px 5px 25px;
            border-bottom: 1px dotted #ddd;
            background: #f4f8f0;
            font-size: 11px;
        }

        .reply-item:last-child {
            border-bottom: none;
        }

        .reply-form {
            padding: 5px 10px;
            background: #eef4e8;
            display: flex;
            gap: 5px;
        }

        .reply-form input {
            flex: 1;
            border: 2px inset #ccc;
            padding: 3px 5px;
            font-size: 11px;
            font-family: Verdana, sans-serif;
        }

        /* ADMIN */
        .admin-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
            flex-wrap: wrap;
        }

        .admin-row select {
            font-size: 11px;
            border: 2px inset #ccc;
            padding: 2px;
        }

        .ban-status {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 2px;
        }

        .ban-active {
            background: #fcc;
            color: #900;
            border: 1px solid #c66;
        }

        .mute-active {
            background: #ffc;
            color: #960;
            border: 1px solid #cc6;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 2px;
            margin-top: 8px;
        }

        .tab {
            background: linear-gradient(180deg, #d0d0d0, #b0b0b0);
            border: 1px solid #999;
            border-bottom: none;
            padding: 4px 14px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            color: #444;
            font-family: Verdana, sans-serif;
        }

        .tab:hover {
            background: linear-gradient(180deg, #ddeedd, #bbddbb);
        }

        .tab.active {
            background: linear-gradient(180deg, #fff, #eee);
            color: #1a5a00;
            border-bottom: 1px solid #eee;
        }

        .panel {
            display: none;
            background: #eee;
            border: 1px solid #999;
            padding: 10px;
        }

        .panel.active {
            display: block;
        }

        /* FOOTER */
        .forum-footer {
            background: linear-gradient(180deg, #1a1a1a, #0d0d0d);
            color: #666;
            text-align: center;
            padding: 6px;
            font-size: 10px;
            border-top: 3px solid #5aad14;
            margin-top: 15px;
        }

        .forum-footer span {
            color: #7dde2f;
        }

        /* STATUS */
        .status-bar {
            background: #ffffcc;
            border: 1px solid #cc9;
            padding: 5px 10px;
            font-size: 11px;
            color: #660;
            margin: 6px 0;
            display: none;
        }

        .status-bar.error {
            background: #ffcccc;
            border-color: #c99;
            color: #600;
        }

        .status-bar.success {
            background: #ccffcc;
            border-color: #9c9;
            color: #060;
        }

        .status-bar.visible {
            display: block;
        }

        .online-count {
            font-size: 10px;
            color: #888;
            text-align: center;
            padding: 4px;
        }

        /* PROFILE */
        .profile-card {
            background: #f8f8f0;
            border: 2px solid #999;
            padding: 15px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info p {
            margin: 4px 0;
        }

        /* LIGHTBOX */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 999;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            border: 3px solid #fff;
        }
    </style>
</head>

<body class="is-guest">

    <div class="forum-header">
        <h1>MC<span>World</span></h1>
        <div class="subtitle">:: MINECRAFT COMMUNITY FORUM :: 2026 ::</div>
    </div>

    <div class="navbar">
        <div class="nav-links">
            <a onclick="showPage('home')">&#127968; Главная</a>
            <a onclick="showPage('forum')" id="nav-forum" style="display:none">&#128172; Форум</a>
            <a onclick="showPage('profile')" id="nav-profile" style="display:none">&#128100; Профиль</a>
            <a onclick="showPage('admin')" id="nav-admin" style="display:none">&#128119; Админ</a>
        </div>
        <div style="padding: 0 8px;">
            <span id="nav-user-info" class="user-info" style="display:none"></span>
            <a onclick="doLogout()" id="nav-logout" style="display:none;color:#cc4444;">[Выход]</a>
        </div>
    </div>

    <div class="wrapper">
        <div class="status-bar" id="status-bar"></div>

        <!-- ===== ГЛАВНАЯ ===== -->
        <div id="page-home">
            <div class="section-header">&#127968; Добро пожаловать на MCWorld Forum!</div>
            <div class="form-box" style="line-height:1.8;">
                <h2>&#9876; История Minecraft</h2>
                <p style="font-size:11px;">
                    <b>Minecraft</b> — это легендарная песочница, созданная шведским программистом <b>Маркусом "Notch"
                        Перссоном</b> в 2009 году.
                    Первая версия (Cave Game) появилась 17 мая 2009 года. Игра быстро стала хитом — миллионы людей по
                    всему миру
                    начали строить, копать и выживать в кубическом мире.
                    <br><br>
                    В 2011 году вышла полная версия 1.0. В 2014 году Microsoft купила Mojang за <b>2.5 миллиарда
                        долларов</b>.
                    Сейчас Minecraft — самая продаваемая игра в истории с более чем <b>300 миллионами</b> проданных
                    копий.
                    <br><br>
                    Крипер, Стив, Эндермен, алмазная кирка — всё это стало частью мировой культуры.
                    Minecraft — это не просто игра, это целая вселенная!
                </p>
            </div>
            <div class="form-box" style="line-height:1.8;">
                <h2>&#128218; История этого сайта</h2>
                <p style="font-size:11px;">
                    Этот форум был создан <b>20 февраля 2026 года</b> примерно в <b>22:00</b>.
                    <br><br>
                    Как это произошло? Всё просто — автору было <b>скучно</b> одним вечером,
                    и он решил взять и сделать свой собственный Minecraft-форум.
                    Буквально на скорую руку, за один вечер, родился этот сайт.
                    <br><br>
                    Сначала это был просто эксперимент, но потом появились регистрация, посты, аватарки,
                    роли, бан-система и многое другое. И вот он — <b>MCWorld Forum</b>, живой и работающий!
                    <br><br>
                    <i>"Когда скучно — программируй. Так рождаются великие вещи."</i>
                </p>
            </div>
        </div>

        <!-- ===== АВТОРИЗАЦИЯ ===== -->
        <div id="page-auth">
            <div class="tabs">
                <div class="tab active" id="tab-login" onclick="switchTab('login')">Вход</div>
                <div class="tab" id="tab-register" onclick="switchTab('register')">Регистрация</div>
            </div>
            <div class="panel active" id="panel-login">
                <div class="form-box">
                    <h2>&#128274; Вход на форум</h2>
                    <div class="form-row">
                        <label>Логин:</label>
                        <input type="text" id="login-username" maxlength="20">
                    </div>
                    <div class="form-row">
                        <label>Пароль:</label>
                        <input type="password" id="login-password" maxlength="50"
                            onkeydown="if(event.key==='Enter')doLogin()">
                    </div>
                    <div class="form-row" style="margin-top:10px;">
                        <label></label>
                        <button class="btn btn-primary" onclick="doLogin()">Войти</button>
                    </div>
                </div>
            </div>
            <div class="panel" id="panel-register">
                <div class="form-box">
                    <h2>&#128221; Регистрация нового игрока</h2>
                    <div class="form-row">
                        <label>Логин:</label>
                        <input type="text" id="reg-username" maxlength="20">
                    </div>
                    <div class="form-row">
                        <label>Пароль:</label>
                        <input type="password" id="reg-password" maxlength="50">
                    </div>
                    <div class="form-row">
                        <label>Пароль ещё раз:</label>
                        <input type="password" id="reg-password2" maxlength="50"
                            onkeydown="if(event.key==='Enter')doRegister()">
                    </div>
                    <div class="form-row" style="margin-top:10px;">
                        <label></label>
                        <button class="btn btn-primary" onclick="doRegister()">Зарегистрироваться</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== ФОРУМ ===== -->
        <div id="page-forum" style="display:none">
            <div class="form-box" id="new-post-form">
                <h2>&#9998; Новая тема</h2>
                <div class="form-row">
                    <label>Заголовок:</label>
                    <input type="text" id="post-title" maxlength="100" style="width:calc(100% - 155px);">
                </div>
                <div class="form-row">
                    <label>Сообщение:</label>
                    <textarea id="post-content"></textarea>
                </div>
                <div class="form-row">
                    <label>Фото / Видео:</label>
                    <input type="file" id="post-media" accept="image/*,video/*">
                    <span id="media-preview-name" style="color:#888;font-size:10px;"></span>
                </div>
                <div class="form-row" style="margin-top:6px;">
                    <label></label>
                    <button class="btn btn-primary" onclick="doPost()">Отправить</button>
                </div>
            </div>
            <div class="section-header">&#128172; Темы форума</div>
            <div id="posts-list">
                <div class="online-count">Загрузка...</div>
            </div>
        </div>

        <!-- ===== ПРОФИЛЬ ===== -->
        <div id="page-profile" style="display:none">
            <div class="section-header">&#128100; Мой профиль</div>
            <div class="profile-card" style="margin-top:0;">
                <div style="text-align:center;">
                    <img id="profile-avatar-img" class="avatar-big" src="" alt="Аватар"
                        onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22><rect fill=%22%23888%22 width=%2280%22 height=%2280%22/><text x=%2240%22 y=%2248%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2232%22>?</text></svg>'">
                    <br>
                    <label class="btn" style="margin-top:6px;display:inline-block;font-size:10px;padding:2px 8px;">
                        Сменить аватарку
                        <input type="file" id="avatar-upload" accept="image/*" style="display:none;"
                            onchange="uploadAvatar(this)">
                    </label>
                </div>
                <div class="profile-info">
                    <p><b>Логин:</b> <span id="profile-username"></span></p>
                    <p><b>Ник:</b> <span id="profile-nickname"></span></p>
                    <p><b>Роль:</b> <span id="profile-role"></span></p>
                    <p><b>Статус:</b> <span id="profile-status"></span></p>
                    <hr style="margin:8px 0;">
                    <div class="form-box" style="margin:5px 0;padding:10px;">
                        <h2 style="font-size:12px;">Сменить ник</h2>
                        <div class="form-row">
                            <label style="width:100px;">Новый ник:</label>
                            <input type="text" id="new-nickname" maxlength="20">
                            <button class="btn" onclick="changeNickname()">Сменить</button>
                        </div>
                    </div>
                    <div class="form-box" style="margin:5px 0;padding:10px;">
                        <h2 style="font-size:12px;">Сменить пароль</h2>
                        <div class="form-row">
                            <label style="width:100px;">Старый:</label>
                            <input type="password" id="old-password" style="width:150px;">
                        </div>
                        <div class="form-row">
                            <label style="width:100px;">Новый:</label>
                            <input type="password" id="new-password" style="width:150px;">
                        </div>
                        <div class="form-row">
                            <label style="width:100px;"></label>
                            <button class="btn" onclick="changePassword()">Сменить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== ЧУЖОЙ ПРОФИЛЬ ===== -->
        <div id="page-userprofile" style="display:none">
            <div class="section-header">&#128100; Профиль игрока</div>
            <div class="profile-card" style="margin-top:0;">
                <div style="text-align:center;">
                    <img id="up-avatar" class="avatar-big" src="">
                </div>
                <div class="profile-info">
                    <p><b>Логин:</b> <span id="up-username"></span></p>
                    <p><b>Ник:</b> <span id="up-nickname"></span></p>
                    <p><b>Роль:</b> <span id="up-role"></span></p>
                    <p><b>На форуме с:</b> <span id="up-registered"></span></p>
                </div>
            </div>
        </div>

        <!-- ===== АДМИН-ПАНЕЛЬ ===== -->
        <div id="page-admin" style="display:none">
            <div class="section-header">&#128119; Админ-панель — Управление пользователями</div>
            <div class="form-box">
                <h2>Роли / Бан / Мут</h2>
                <p style="font-size:10px;color:#888;margin-bottom:8px;">
                    Роли:
                    <span class="role-badge role-player">Игрок</span>
                    <span class="role-badge role-vip">ВИП</span>
                    <span class="role-badge role-moder">Модер</span>
                    <span class="role-badge role-admin">Админ</span>
                </p>
                <div id="admin-users-list">Загрузка...</div>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div class="lightbox" id="lightbox" onclick="this.classList.remove('active')">
        <img id="lightbox-img" src="">
    </div>

    <div class="forum-footer">
        Powered by <span>MCWorld Forum Engine</span> v2.0 &copy; 2026 |
        Хостинг: localhost:8000 | Все права защищены
    </div>

    <script>
        let currentUser = null;
        let currentRole = null;
        const DEFAULT_AVATAR = "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="#888" width="80" height="80"/><text x="40" y="48" text-anchor="middle" fill="white" font-size="32">?</text></svg>');

        async function api(method, url, body) {
            const opts = { method, headers: {} };
            if (body) { opts.headers["Content-Type"] = "application/json"; opts.body = JSON.stringify(body); }
            const res = await fetch(url, opts);
            return await res.json();
        }

        function showStatus(msg, type) {
            const el = document.getElementById("status-bar");
            el.textContent = msg;
            el.className = "status-bar visible " + (type || "");
            setTimeout(() => { el.className = "status-bar"; }, 4000);
        }

        function switchTab(tab) {
            document.getElementById("tab-login").className = tab === "login" ? "tab active" : "tab";
            document.getElementById("tab-register").className = tab === "register" ? "tab active" : "tab";
            document.getElementById("panel-login").className = tab === "login" ? "panel active" : "panel";
            document.getElementById("panel-register").className = tab === "register" ? "panel active" : "panel";
        }

        function showPage(page) {
            ["home", "auth", "forum", "profile", "admin", "userprofile"].forEach(p => {
                document.getElementById("page-" + p).style.display = p === page ? "" : "none";
            });
            if (page === "forum") loadPosts();
            if (page === "admin") loadAdminUsers();
            if (page === "profile") loadProfile();
        }

        async function viewProfile(username) {
            const data = await api("GET", "/api/profile/" + encodeURIComponent(username));
            if (data.error) { showStatus(data.error, "error"); return; }
            document.getElementById("up-avatar").src = data.avatar || DEFAULT_AVATAR;
            document.getElementById("up-username").textContent = data.username;
            document.getElementById("up-nickname").textContent = data.nickname || data.username;
            document.getElementById("up-role").innerHTML = roleBadge(data.role);
            document.getElementById("up-registered").textContent = new Date(data.registered * 1000).toLocaleDateString("ru-RU");
            showPage("userprofile");
        }

        // ========== AUTH ==========
        async function doLogin() {
            const username = document.getElementById("login-username").value.trim();
            const password = document.getElementById("login-password").value;
            if (!username || !password) { showStatus("Заполни все поля!", "error"); return; }
            const data = await api("POST", "/api/login", { username, password });
            if (data.error) { showStatus(data.error, "error"); return; }
            setLoggedIn(data.username, data.role);
            showStatus("Добро пожаловать, " + data.username + "!", "success");
        }

        async function doRegister() {
            const username = document.getElementById("reg-username").value.trim();
            const password = document.getElementById("reg-password").value;
            const password2 = document.getElementById("reg-password2").value;
            if (!username || !password) { showStatus("Заполни все поля!", "error"); return; }
            if (password !== password2) { showStatus("Пароли не совпадают!", "error"); return; }
            const data = await api("POST", "/api/register", { username, password });
            if (data.error) { showStatus(data.error, "error"); return; }
            setLoggedIn(data.username, data.role);
            showStatus("Регистрация успешна!", "success");
        }

        async function doLogout() {
            await api("POST", "/api/logout", {});
            currentUser = null; currentRole = null;
            document.body.className = "is-guest";
            ["nav-user-info", "nav-logout", "nav-admin", "nav-profile", "nav-forum"].forEach(id => {
                document.getElementById(id).style.display = "none";
            });
            showPage("auth");
            showStatus("Вы вышли из аккаунта", "success");
        }

        function setLoggedIn(username, role) {
            currentUser = username; currentRole = role;
            document.getElementById("nav-user-info").style.display = "inline";
            document.getElementById("nav-user-info").innerHTML = username + " " + roleBadge(role);
            document.getElementById("nav-logout").style.display = "inline";
            document.getElementById("nav-forum").style.display = "inline";
            document.getElementById("nav-profile").style.display = "inline";
            document.getElementById("nav-admin").style.display = (role === "admin" || role === "moder") ? "inline" : "none";
            document.getElementById("new-post-form").style.display = "";
            showPage("forum");
        }

        function roleBadge(role) {
            const labels = { player: "Игрок", vip: "ВИП", moder: "Модер", admin: "Админ" };
            return '<span class="role-badge role-' + role + '">' + (labels[role] || role) + '</span>';
        }

        function avatarImg(src, cls) {
            const s = src || DEFAULT_AVATAR;
            return '<img class="' + (cls || "avatar-small") + '" src="' + esc(s) + '" onerror="this.src=\'' + DEFAULT_AVATAR + '\'">';
        }

        // ========== POSTS ==========
        async function loadPosts() {
            const data = await api("GET", "/api/posts");
            const list = document.getElementById("posts-list");
            if (!data.posts || data.posts.length === 0) {
                list.innerHTML = '<div class="online-count">Тем пока нет. Будь первым!</div>';
                return;
            }
            let html = "";
            for (const post of data.posts) {
                const date = new Date(post.time * 1000).toLocaleString("ru-RU");
                const canDelete = currentRole === "admin" || currentRole === "moder";
                html += '<div class="post-item">';
                html += '<div class="post-header"><div class="post-author">';
                html += avatarImg(post.avatar) + ' ';
                html += '<a class="post-author-name" onclick="viewProfile(\'' + esc(post.author) + '\')">' + esc(post.nickname || post.author) + '</a>';
                html += roleBadge(post.role);
                html += ' &mdash; <span class="post-title">' + esc(post.title) + '</span>';
                html += '</div><div class="post-meta">' + date;
                if (canDelete) {
                    html += ' <button class="btn btn-danger" style="font-size:9px;padding:1px 6px;margin-left:4px;" onclick="deletePost(\'' + post.id + '\')">X</button>';
                }
                html += '</div></div>';
                html += '<div class="post-body">' + esc(post.content) + '</div>';

                if (post.media) {
                    html += '<div class="post-media">';
                    if (post.media_type === "image") {
                        html += '<img src="' + esc(post.media) + '" onclick="openLightbox(\'' + esc(post.media) + '\')">';
                    } else if (post.media_type === "video") {
                        html += '<video controls src="' + esc(post.media) + '"></video>';
                    }
                    html += '</div>';
                }

                if (post.replies && post.replies.length > 0) {
                    html += '<div class="replies">';
                    for (const r of post.replies) {
                        const rdate = new Date(r.time * 1000).toLocaleString("ru-RU");
                        html += '<div class="reply-item">';
                        html += avatarImg(r.avatar) + ' ';
                        html += '<a onclick="viewProfile(\'' + esc(r.author) + '\')" style="font-weight:bold;cursor:pointer;">' + esc(r.nickname || r.author) + '</a> ' + roleBadge(r.role);
                        html += ' <span style="color:#888;font-size:9px;">' + rdate + '</span><br>';
                        html += esc(r.content) + '</div>';
                    }
                    html += '</div>';
                }

                if (currentUser) {
                    html += '<div class="reply-form">';
                    html += '<input type="text" id="reply-' + post.id + '" placeholder="Написать ответ..." onkeydown="if(event.key===\'Enter\')doReply(\'' + post.id + '\')">';
                    html += '<button class="btn" onclick="doReply(\'' + post.id + '\')">Ответить</button>';
                    html += '</div>';
                }
                html += '</div>';
            }
            list.innerHTML = html;
        }

        async function doPost() {
            const title = document.getElementById("post-title").value.trim();
            const content = document.getElementById("post-content").value.trim();
            if (!title || !content) { showStatus("Заполни заголовок и сообщение!", "error"); return; }

            let media = "";
            let media_name = "";
            const fileInput = document.getElementById("post-media");
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 10 * 1024 * 1024) { showStatus("Файл слишком большой (макс 10МБ)!", "error"); return; }
                media = await readFileAsBase64(file);
                media_name = file.name;
            }

            const data = await api("POST", "/api/posts", { title, content, media, media_name });
            if (data.error) { showStatus(data.error, "error"); return; }
            document.getElementById("post-title").value = "";
            document.getElementById("post-content").value = "";
            fileInput.value = "";
            showStatus("Тема создана!", "success");
            loadPosts();
        }

        async function doReply(postId) {
            const input = document.getElementById("reply-" + postId);
            const content = input.value.trim();
            if (!content) return;
            const data = await api("POST", "/api/reply", { post_id: postId, content });
            if (data.error) { showStatus(data.error, "error"); return; }
            loadPosts();
        }

        async function deletePost(postId) {
            if (!confirm("Удалить эту тему?")) return;
            await api("POST", "/api/admin/delete_post", { post_id: postId });
            showStatus("Тема удалена", "success");
            loadPosts();
        }

        // ========== PROFILE ==========
        async function loadProfile() {
            const data = await api("GET", "/api/me");
            if (!data.username) { showPage("auth"); return; }
            document.getElementById("profile-username").textContent = data.username;
            document.getElementById("profile-nickname").textContent = data.nickname || data.username;
            document.getElementById("profile-role").innerHTML = roleBadge(data.role);
            document.getElementById("profile-avatar-img").src = data.avatar || DEFAULT_AVATAR;
            document.getElementById("new-nickname").value = data.nickname || data.username;

            let status = "Активен";
            if (data.ban_until > Date.now() / 1000) {
                const r = Math.ceil((data.ban_until - Date.now() / 1000) / 60);
                status = "ЗАБАНЕН (осталось " + r + " мин)";
            }
            if (data.mute_until > Date.now() / 1000) {
                const r = Math.ceil((data.mute_until - Date.now() / 1000) / 60);
                status += " | ЗАМЬЮЧЕН (осталось " + r + " мин)";
            }
            document.getElementById("profile-status").textContent = status;
        }

        async function uploadAvatar(input) {
            if (!input.files.length) return;
            const file = input.files[0];
            if (file.size > 2 * 1024 * 1024) { showStatus("Аватарка слишком большая (макс 2МБ)!", "error"); return; }
            const b64 = await readFileAsBase64(file);
            const data = await api("POST", "/api/profile/avatar", { avatar: b64 });
            if (data.error) { showStatus(data.error, "error"); return; }
            showStatus("Аватарка обновлена!", "success");
            loadProfile();
        }

        async function changeNickname() {
            const nick = document.getElementById("new-nickname").value.trim();
            if (!nick) { showStatus("Введи ник!", "error"); return; }
            const data = await api("POST", "/api/profile/nickname", { nickname: nick });
            if (data.error) { showStatus(data.error, "error"); return; }
            showStatus("Ник изменён!", "success");
            loadProfile();
            document.getElementById("nav-user-info").innerHTML = currentUser + " " + roleBadge(currentRole);
        }

        async function changePassword() {
            const oldPw = document.getElementById("old-password").value;
            const newPw = document.getElementById("new-password").value;
            if (!oldPw || !newPw) { showStatus("Заполни оба поля!", "error"); return; }
            const data = await api("POST", "/api/profile/password", { old_password: oldPw, new_password: newPw });
            if (data.error) { showStatus(data.error, "error"); return; }
            showStatus("Пароль изменён!", "success");
            document.getElementById("old-password").value = "";
            document.getElementById("new-password").value = "";
        }

        // ========== ADMIN ==========
        async function loadAdminUsers() {
            const data = await api("GET", "/api/users");
            if (data.error) { showStatus(data.error, "error"); return; }
            const list = document.getElementById("admin-users-list");
            const now = Date.now() / 1000;
            let html = "";
            for (const u of data.users) {
                const isBanned = u.ban_until > now;
                const isMuted = u.mute_until > now;
                html += '<div class="admin-row">';
                html += avatarImg(u.avatar) + ' ';
                html += '<b>' + esc(u.username) + '</b> ';
                if (u.nickname && u.nickname !== u.username) html += '(' + esc(u.nickname) + ') ';
                html += roleBadge(u.role) + ' ';
                if (isBanned) html += '<span class="ban-status ban-active">ЗАБАНЕН</span> ';
                if (isMuted) html += '<span class="ban-status mute-active">ЗАМЬЮЧЕН</span> ';

                if (currentRole === "admin") {
                    html += '<select id="role-sel-' + esc(u.username) + '">';
                    html += '<option value="player"' + (u.role === "player" ? " selected" : "") + '>Игрок</option>';
                    html += '<option value="vip"' + (u.role === "vip" ? " selected" : "") + '>ВИП</option>';
                    html += '<option value="moder"' + (u.role === "moder" ? " selected" : "") + '>Модер</option>';
                    html += '<option value="admin"' + (u.role === "admin" ? " selected" : "") + '>Админ</option>';
                    html += '</select>';
                    html += '<button class="btn" onclick="changeRole(\'' + esc(u.username) + '\')" style="font-size:10px;padding:2px 6px;">Роль</button> ';
                }

                html += '<select id="dur-sel-' + esc(u.username) + '">';
                html += '<option value="1800">30 мин</option>';
                html += '<option value="3600">1 час</option>';
                html += '<option value="7200">2 часа</option>';
                html += '<option value="43200">12 часов</option>';
                html += '<option value="86400">1 день</option>';
                if (currentRole === "admin") {
                    html += '<option value="604800">7 дней</option>';
                    html += '<option value="2592000">30 дней</option>';
                    html += '<option value="99999999">Навсегда</option>';
                }
                html += '</select>';

                if (!isBanned) {
                    html += '<button class="btn btn-danger" onclick="doBan(\'' + esc(u.username) + '\')" style="font-size:10px;padding:2px 6px;">Бан</button>';
                } else {
                    html += '<button class="btn btn-success" onclick="doUnban(\'' + esc(u.username) + '\')" style="font-size:10px;padding:2px 6px;">Разбан</button>';
                }
                if (!isMuted) {
                    html += '<button class="btn btn-warn" onclick="doMute(\'' + esc(u.username) + '\')" style="font-size:10px;padding:2px 6px;">Мут</button>';
                } else {
                    html += '<button class="btn btn-success" onclick="doUnmute(\'' + esc(u.username) + '\')" style="font-size:10px;padding:2px 6px;">Размут</button>';
                }
                html += '</div>';
            }
            list.innerHTML = html;
        }

        async function changeRole(username) {
            const role = document.getElementById("role-sel-" + username).value;
            const data = await api("POST", "/api/admin/role", { username, role });
            if (data.error) { showStatus(data.error, "error"); return; }
            showStatus("Роль " + username + " изменена!", "success");
            loadAdminUsers();
        }

        async function doBan(username) {
            const duration = document.getElementById("dur-sel-" + username).value;
            const data = await api("POST", "/api/admin/ban", { username, duration: parseInt(duration) });
            if (data.error) { showStatus(data.error, "error"); return; }
            showStatus(username + " забанен!", "success");
            loadAdminUsers();
        }

        async function doUnban(username) {
            await api("POST", "/api/admin/unban", { username });
            showStatus(username + " разбанен!", "success");
            loadAdminUsers();
        }

        async function doMute(username) {
            const duration = document.getElementById("dur-sel-" + username).value;
            const data = await api("POST", "/api/admin/mute", { username, duration: parseInt(duration) });
            if (data.error) { showStatus(data.error, "error"); return; }
            showStatus(username + " замьючен!", "success");
            loadAdminUsers();
        }

        async function doUnmute(username) {
            await api("POST", "/api/admin/unmute", { username });
            showStatus(username + " размьючен!", "success");
            loadAdminUsers();
        }

        // ========== UTILS ==========
        function esc(str) {
            if (!str) return "";
            const d = document.createElement("div"); d.textContent = str; return d.innerHTML;
        }

        function readFileAsBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        function openLightbox(src) {
            document.getElementById("lightbox-img").src = src;
            document.getElementById("lightbox").classList.add("active");
        }

        // ========== INIT ==========
        async function init() {
            const data = await api("GET", "/api/me");
            if (data.username) {
                setLoggedIn(data.username, data.role);
            } else {
                showPage("auth");
            }
        }
        init();

        setInterval(() => {
            if (document.getElementById("page-forum").style.display !== "none") loadPosts();
        }, 10000);
    </script>
</body>

</html>
